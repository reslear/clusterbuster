<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Add a vector tile source</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .map-overlay {
        position: absolute;
        width: 25%;
        top: 0;
        bottom: 0;
        left: 0;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        background-color: #fff;
        max-height: 100%;
        overflow: hidden;
      }

      label {
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div class="map-overlay">
      <div>
        <div><h1>Speed</h1></div>

        <div>
          <label>
            <input type="checkbox" name="speed" value="fast" /> Speed
          </label>
        </div>

        <div>
          <label
            ><input type="checkbox" name="speed" value="turbo" /> Turbo</label
          >
        </div>
      </div>
    </div>

    <script>
      mapboxgl.accessToken =
        'pk.eyJ1IjoiaG9vbG9rbyIsImEiOiJja2hjZGUwbDgwMjM1MnFtMHZ6cmVxZmlnIn0.kUJgLf2zFIFIqAwY8-73CQ';
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        zoom: 4,
        center: [5.9511792677838, 59.29614383405024],
      });

      map.on('load', () => {
        map.addSource('points', {
          type: 'vector',
          tiles: ['http://localhost:3005/points/{z}/{x}/{y}/tile.mvt'],
        });

        map.addLayer({
          id: 'clusters',
          type: 'circle',
          source: 'points',
          'source-layer': 'points',
          interactive: true,
          filter: ['>', ['get', 'count'], 1],
          paint: {
            'circle-radius': 20,
          },
        });

        map.addLayer({
          id: 'cluster_count',
          type: 'symbol',
          source: 'points',
          'source-layer': `points`,

          interactive: true,
          filter: ['>', ['get', 'count'], 1],

          layout: {
            'text-field': ['get', 'count'],
            'text-size': 12,
          },

          paint: {
            'text-color': '#ffffff',
          },
        });

        map.addLayer({
          id: 'unclustered-point',
          type: 'circle',
          source: 'points',
          'source-layer': `points`,
          filter: ['==', ['get', 'count'], 1],
          //'icon-allow-overlap': true,
          paint: {
            'circle-color': '#11b4da',
            'circle-radius': 4,
            'circle-stroke-width': 1,
            'circle-stroke-color': '#fff',
          },
        });

        map.on('click', function ({ point, target }) {
          const features = target.queryRenderedFeatures(point, {
            layers: ['clusters', 'cluster_count', 'unclustered-point'],
          });

          if (features && features.length > 0) {
            map.flyTo({
              center: [features[0].properties.lng, features[0].properties.lat],
            });
          }
        });
      });

      const inputChange = (event) => {
        const inps = document.querySelectorAll('input[name="speed"]:checked');
        const values = [...inps].map((item) => item.value);

        var filters = [['in', ['get', 'speed'], ['literal', values]]];

        console.log(values, filters);

        map.setFilter('unclustered-point', [
          'all',
          ['==', ['get', 'count'], 1],
          ...filters,
        ]);
        map.setFilter('clusters', [
          'all',
          ['>', ['get', 'count'], 1],
          //...filters,
        ]);
        map.setFilter('cluster_count', [
          'all',
          ['>', ['get', 'count'], 1],
          //...filters,
        ]);
      };

      const speedInputs = document.querySelectorAll('input[name="speed"]');

      speedInputs.forEach((input) => {
        input.addEventListener('change', inputChange);
      });
    </script>
  </body>
</html>
